const order = ['red', 'yellow', 'blue', 'green', 'red']
const data = {
  data: {
    picDoList: [{
      autoMatch: null, gmtCreate: 1535886323000, gmtModified: 1542801568000, groupId: '20180901', height: 2240, id: 74744, isIdentified: null, path: '/data/si_board/si_board/20180901/pic/赵强004/ZQ_13836.jpg', position: null, score: null, size: '2.4MB', thumbUrl: 'https://devres.alphalawyer.cn/si_board/20180901/pic/赵强004/ZQ_13836.jpg_200', unionId: null, url: 'https://devres.alphalawyer.cn/si_board/20180901/pic/赵强004/ZQ_13836.jpg', width: 3360
    }, {
      autoMatch: null, gmtCreate: 1535886321000, gmtModified: 1542801566000, groupId: '20180901', height: 2046, id: 74740, isIdentified: null, path: '/data/si_board/si_board/20180901/pic/赵强004/ZQ_13829.jpg', position: null, score: null, size: '2.4MB', thumbUrl: 'https://devres.alphalawyer.cn/si_board/20180901/pic/赵强004/ZQ_13829.jpg_200', unionId: null, url: 'https://devres.alphalawyer.cn/si_board/20180901/pic/赵强004/ZQ_13829.jpg', width: 3069
    }, {
      autoMatch: null, gmtCreate: 1535886319000, gmtModified: 1542801564000, groupId: '20180901', height: 2240, id: 74739, isIdentified: null, path: '/data/si_board/si_board/20180901/pic/赵强004/ZQ_13826.jpg', position: null, score: null, size: '2.8MB', thumbUrl: 'https://devres.alphalawyer.cn/si_board/20180901/pic/赵强004/ZQ_13826.jpg_200', unionId: null, url: 'https://devres.alphalawyer.cn/si_board/20180901/pic/赵强004/ZQ_13826.jpg', width: 3360
    }, {
      autoMatch: null, gmtCreate: 1535886317000, gmtModified: 1542801562000, groupId: '20180901', height: 1999, id: 74736, isIdentified: null, path: '/data/si_board/si_board/20180901/pic/赵强004/ZQ_13822.jpg', position: null, score: null, size: '2.0MB', thumbUrl: 'https://devres.alphalawyer.cn/si_board/20180901/pic/赵强004/ZQ_13822.jpg_200', unionId: null, url: 'https://devres.alphalawyer.cn/si_board/20180901/pic/赵强004/ZQ_13822.jpg', width: 2998
    }, {
      autoMatch: null, gmtCreate: 1535886316000, gmtModified: 1542801560000, groupId: '20180901', height: 1919, id: 74734, isIdentified: null, path: '/data/si_board/si_board/20180901/pic/赵强004/ZQ_13820.jpg', position: null, score: null, size: '1.8MB', thumbUrl: 'https://devres.alphalawyer.cn/si_board/20180901/pic/赵强004/ZQ_13820.jpg_200', unionId: null, url: 'https://devres.alphalawyer.cn/si_board/20180901/pic/赵强004/ZQ_13820.jpg', width: 2878
    }, {
      autoMatch: null, gmtCreate: 1535886315000, gmtModified: 1542801559000, groupId: '20180901', height: 2240, id: 74733, isIdentified: null, path: '/data/si_board/si_board/20180901/pic/赵强004/ZQ_13818.jpg', position: null, score: null, size: '3.4MB', thumbUrl: 'https://devres.alphalawyer.cn/si_board/20180901/pic/赵强004/ZQ_13818.jpg_200', unionId: null, url: 'https://devres.alphalawyer.cn/si_board/20180901/pic/赵强004/ZQ_13818.jpg', width: 3360
    }, {
      autoMatch: null, gmtCreate: 1535886313000, gmtModified: 1542801556000, groupId: '20180901', height: 2240, id: 74730, isIdentified: null, path: '/data/si_board/si_board/20180901/pic/赵强004/ZQ_13816.jpg', position: null, score: null, size: '3.8MB', thumbUrl: 'https://devres.alphalawyer.cn/si_board/20180901/pic/赵强004/ZQ_13816.jpg_200', unionId: null, url: 'https://devres.alphalawyer.cn/si_board/20180901/pic/赵强004/ZQ_13816.jpg', width: 3360
    }, {
      autoMatch: null, gmtCreate: 1535886310000, gmtModified: 1542801553000, groupId: '20180901', height: 1803, id: 74728, isIdentified: null, path: '/data/si_board/si_board/20180901/pic/赵强004/ZQ_13811.jpg', position: null, score: null, size: '1.6MB', thumbUrl: 'https://devres.alphalawyer.cn/si_board/20180901/pic/赵强004/ZQ_13811.jpg_200', unionId: null, url: 'https://devres.alphalawyer.cn/si_board/20180901/pic/赵强004/ZQ_13811.jpg', width: 2704
    }, {
      autoMatch: null, gmtCreate: 1535886309000, gmtModified: 1542801552000, groupId: '20180901', height: 1803, id: 74726, isIdentified: null, path: '/data/si_board/si_board/20180901/pic/赵强004/ZQ_13808.jpg', position: null, score: null, size: '1.5MB', thumbUrl: 'https://devres.alphalawyer.cn/si_board/20180901/pic/赵强004/ZQ_13808.jpg_200', unionId: null, url: 'https://devres.alphalawyer.cn/si_board/20180901/pic/赵强004/ZQ_13808.jpg', width: 2704
    }, {
      autoMatch: null, gmtCreate: 1535886308000, gmtModified: 1542801550000, groupId: '20180901', height: 1803, id: 74724, isIdentified: null, path: '/data/si_board/si_board/20180901/pic/赵强004/ZQ_13805.jpg', position: null, score: null, size: '1.7MB', thumbUrl: 'https://devres.alphalawyer.cn/si_board/20180901/pic/赵强004/ZQ_13805.jpg_200', unionId: null, url: 'https://devres.alphalawyer.cn/si_board/20180901/pic/赵强004/ZQ_13805.jpg', width: 2704
    }, {
      autoMatch: null, gmtCreate: 1535886305000, gmtModified: 1542801549000, groupId: '20180901', height: 1888, id: 74720, isIdentified: null, path: '/data/si_board/si_board/20180901/pic/赵强004/ZQ_13802.jpg', position: null, score: null, size: '1.8MB', thumbUrl: 'https://devres.alphalawyer.cn/si_board/20180901/pic/赵强004/ZQ_13802.jpg_200', unionId: null, url: 'https://devres.alphalawyer.cn/si_board/20180901/pic/赵强004/ZQ_13802.jpg', width: 2832
    }]
  }
}

function transformRpx(rpx) {
  const systemInfo = wx.getSystemInfoSync()
  const px = rpx / 750 * systemInfo.windowWidth
  return px
}

const imgHeight = transformRpx(248)

// 搜选框防抖
function debounce(method, time) {
  let timer = null
  return function () {
    const context = this
    // 在函数执行的时候先清除timer定时器;
    clearTimeout(timer)
    timer = setTimeout(function () {
      method.call(context)
    }, time)
  }
}

let scrollTop = 0

const imgArr = []

data.data.picDoList.map(item => {
  item.scale = 1
  item.x = 0
  item.y = 0
  imgArr.push({
    src: item.url + '_1280',
    scale: 1
  })
  return true
})

let startX = 0

let scale = false

Component({
  properties: {
  },
  data: {
    toView: 'red',
    scrollTop: 100,
    data: data.data.picDoList,
    current: 0,
    itemIndex: 1,
    translateX: 0,
    scrollLeft: 0,
    x: 0,
    y: 0
  },
  ready() {
    // this.preview()
    this.changeItem()
  },
  methods: {
    onScale(e) {
      const {dataset} = e.currentTarget
      const {detail} = e
      const {data} = this.data
      data[dataset.index].scale = detail.scales
      scale = true
    },
    touchstart(e) {
      if (e.touches.length === 1) {
        const {pageX} = e.touches[0]
        startX = pageX
      }
    },
    touchend(e) {
      if (scale) {
        setTimeout(() => {
          scale = false
        }, 1000)
        return false
      }

      const {pageX} = e.changedTouches[0]
      const {data} = this.data
      const {dataset} = e.currentTarget

      if (!startX) {
        return false
      }

      const curIndex = dataset.index

      if (data[curIndex].scale > 1) {
        const delta = transformRpx(750) + data[curIndex].x
        if (delta > 20 && delta < transformRpx(750) - 20) {
          return false
        }
      }


      if (startX < pageX && pageX - startX > 30) {
      // 右滑
        this.rightScroll(curIndex)
      } else if (startX > pageX && startX - pageX > 30) {
      // 左滑
        this.leftScroll(curIndex)
      }

      startX = 0
      return true
    },
    leftScroll(curIndex) {
      const {scrollLeft, data} = this.data

      if (data[curIndex]) {
        data[curIndex].preview = true
      }
      if (data[curIndex + 1]) {
        data[curIndex + 1].preview = true
      }
      if (data[curIndex + 2]) {
        data[curIndex + 2].preview = true
      }
      if (data[curIndex - 3]) {
        data[curIndex - 3].preview = false
      }

      if (scrollLeft < data.length * transformRpx(750)) {
        this.setData({
          scrollLeft: curIndex * transformRpx(750) + transformRpx(750),
          data,
          itemIndex: curIndex + 2
        })
      }
    },
    rightScroll(curIndex) {
      const {scrollLeft, data} = this.data
      if (data[curIndex]) {
        data[curIndex].preview = true
      }

      if (data[curIndex - 1]) {
        data[curIndex - 1].preview = true
      }

      if (data[curIndex - 2]) {
        data[curIndex - 2].preview = true
      }

      if (data[curIndex + 3]) {
        data[curIndex + 3].preview = false
      }

      if (scrollLeft > 0) {
        this.setData({
          scrollLeft: curIndex * transformRpx(750) - transformRpx(750),
          data,
          itemIndex: curIndex
        })
      }
    },
    onChange(e) {
      const {dataset} = e.currentTarget
      const {detail} = e
      const {data} = this.data
      data[dataset.index].x = detail.x
      data[dataset.index].y = detail.y
    },
    upper() {
      // console.log(e)
    },
    lower() {
      // console.log(e)
    },
    scroll(e) {
      scrollTop = e.detail.scrollTop
      this.changeItem()
    },
    changeItem: debounce(function () {
      console.log(this)

      const {data} = this.data
      const minConlum = (Math.floor(scrollTop / imgHeight) - 2) * 3
      const maxConlum = minConlum + 8 * 3
      data.map((item, index) => {
        if (index >= minConlum && index < maxConlum) {
          item.show = true
        }
        return true
      })

      this.setData({
        data
      })
    }, 500),
    tap() {
      for (let i = 0; i < order.length; ++i) {
        if (order[i] === this.data.toView) {
          this.setData({
            toView: order[i + 1]
          })
          break
        }
      }
    },
    tapMove() {
      this.setData({
        scrollTop: this.data.scrollTop + 10
      })
    },
    preview(e) {
      const {data} = this.data
      const {url} = e.currentTarget.dataset

      const index = data.findIndex((value) => value.url === url)


      data[index].preview = true
      data[index + 1].preview = true
      data[index + 2].preview = true


      this.setData({
        data,
        scrollLeft: index * transformRpx(750),
        previewShow: true,
        itemIndex: index + 1
      })
    },
    close() {
      this.setData({
        previewShow: false
      })
    },
    bindload(e) {
      console.log(e)
    },
  }
})
